const { sequelize } = require('../models')

async function generatePreResponses() {
  try {
    console.log('🔌 连接数据库中...')
    await sequelize.authenticate()
    console.log('✅ 数据库连接成功!')
    
    // 先查询所有核心意图
    const [coreIntents] = await sequelize.query('SELECT id, name, description FROM core_intents ORDER BY id;')
    console.log(`📊 发现 ${coreIntents.length} 个核心意图`)
    
    // 清空现有的先行回复
    await sequelize.query('DELETE FROM pre_responses;')
    console.log('🗑️ 已清空现有回复模板')
    
    // 为每个核心意图定义回复模板
    const responseTemplates = {
      '播放音乐': [
        '好的，正在为您播放音乐...',
        '马上为您播放，请稍等...',
        '音乐即将开始播放！'
      ],
      '暂停音乐': [
        '音乐已暂停',
        '好的，已暂停播放',
        '播放已停止'
      ],
      '查询天气': [
        '正在查询天气信息，请稍候...',
        '马上为您查询当前天气...',
        '正在获取最新天气数据...'
      ],
      '开灯': [
        '好的，正在为您开灯...',
        '灯光即将点亮！',
        '正在打开房间灯光...'
      ],
      '关灯': [
        '正在关闭灯光...',
        '好的，已为您关灯',
        '灯光已关闭'
      ],
      '时间查询': [
        '正在为您查询当前时间...',
        '马上告诉您现在几点了',
        '正在获取准确时间信息...'
      ],
      '日期查询': [
        '正在查询今天的日期...',
        '马上为您确认当前日期',
        '正在获取日期信息...'
      ],
      '天气查询': [
        '正在查询天气状况...',
        '马上为您播报天气情况',
        '正在获取最新天气预报...'
      ],
      '播放功能': [
        '正在启动播放功能...',
        '播放系统准备就绪',
        '正在为您准备播放内容...'
      ],
      '设置提醒': [
        '好的，正在为您设置提醒...',
        '提醒已记录，时间到了会通知您',
        '提醒设置完成！'
      ],
      '搜索功能': [
        '正在为您搜索相关信息...',
        '搜索功能已启动，请稍等...',
        '正在查找您需要的内容...'
      ],
      '计算功能': [
        '正在为您计算...',
        '计算中，请稍候...',
        '马上为您得出结果...'
      ],
      '翻译功能': [
        '正在为您翻译...',
        '翻译功能启动中...',
        '马上为您提供翻译结果...'
      ],
      '如何询问': [
        '我来为您解答如何操作...',
        '让我告诉您具体方法...',
        '正在为您查找操作指南...'
      ],
      '为什么询问': [
        '我来为您解释原因...',
        '让我告诉您为什么...',
        '正在为您分析原因...'
      ],
      '控制设备': [
        '正在连接设备控制系统...',
        '设备控制指令已发送',
        '正在执行设备操作...'
      ],
      '信息查询': [
        '正在为您查询相关信息...',
        '信息搜索中，请稍等...',
        '马上为您找到需要的信息...'
      ],
      '导航路线': [
        '正在为您规划最佳路线...',
        '导航系统启动中...',
        '正在计算最优行驶路径...'
      ],
      '购物服务': [
        '正在为您查找商品信息...',
        '购物助手已启动...',
        '正在搜索相关商品...'
      ],
      '通话服务': [
        '正在为您发起通话...',
        '通话功能准备中...',
        '正在连接通话服务...'
      ],
      '邮件服务': [
        '正在为您处理邮件...',
        '邮件系统已启动...',
        '正在准备邮件功能...'
      ],
      '短信服务': [
        '正在为您发送短信...',
        '短信功能启动中...',
        '正在处理短信请求...'
      ],
      '新闻资讯': [
        '正在为您获取最新新闻...',
        '新闻播报准备中...',
        '正在搜索热点资讯...'
      ],
      '股票查询': [
        '正在查询股票行情...',
        '股市数据获取中...',
        '正在为您查找股票信息...'
      ],
      '汇率查询': [
        '正在查询最新汇率...',
        '汇率信息获取中...',
        '正在为您查找汇率数据...'
      ],
      '订票服务': [
        '正在为您查询票务信息...',
        '订票系统启动中...',
        '正在搜索可用票源...'
      ],
      '智能家居控制': [
        '正在连接智能家居系统...',
        '家居设备控制中...',
        '正在执行智能家居指令...'
      ],
      '健康医疗咨询': [
        '正在为您查询健康信息...',
        '医疗咨询系统启动中...',
        '正在搜索相关医疗建议...'
      ],
      '教育学习': [
        '正在为您准备学习内容...',
        '教育资源搜索中...',
        '正在查找学习资料...'
      ],
      '金融理财': [
        '正在为您查询理财信息...',
        '金融数据获取中...',
        '正在分析理财建议...'
      ],
      '旅游出行': [
        '正在为您规划旅行方案...',
        '旅游信息搜索中...',
        '正在查找出行建议...'
      ],
      '美食餐饮': [
        '正在为您推荐美食...',
        '餐饮信息搜索中...',
        '正在查找美食攻略...'
      ],
      '运动健身': [
        '正在为您制定运动计划...',
        '健身指导准备中...',
        '正在搜索运动建议...'
      ],
      '工作办公': [
        '正在为您准备办公工具...',
        '工作助手启动中...',
        '正在处理办公需求...'
      ]
    }
    
    let totalInserted = 0
    
    // 为每个核心意图插入回复模板
    for (const intent of coreIntents) {
      const templates = responseTemplates[intent.name] || [
        `正在为您处理${intent.name}请求...`,
        `${intent.name}功能启动中...`,
        `正在执行${intent.name}操作...`
      ]
      
      for (let i = 0; i < templates.length; i++) {
        await sequelize.query(`
          INSERT INTO pre_responses (coreIntentId, content, priority, status, usageCount, createdAt, updatedAt) 
          VALUES (?, ?, ?, 'active', 0, datetime('now'), datetime('now'))
        `, {
          replacements: [intent.id, templates[i], i + 1]
        })
        totalInserted++
      }
      
      console.log(`✓ 为"${intent.name}"添加了 ${templates.length} 个回复模板`)
    }
    
    console.log(`\n🎉 回复模板生成完成！`)
    console.log(`📊 总计插入 ${totalInserted} 个回复模板`)
    
    // 验证插入结果
    const [count] = await sequelize.query('SELECT COUNT(*) as total FROM pre_responses;')
    console.log(`✅ 数据库中现有 ${count[0].total} 个回复模板`)
    
  } catch (error) {
    console.error('❌ 生成回复模板失败:', error.message)
  } finally {
    await sequelize.close()
  }
}

generatePreResponses() 